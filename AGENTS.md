# AGENTS 指南（项目根生效）

本文件为协作型编码助手（Codex CLI）在本仓库的工作约定与启动清单。作用域为仓库根目录及其所有子目录。

## 启动清单（每次新会话）
- 快速概览根目录与关键文件：`README.md`、`PROJECT_LOG.md`、`notes/rules.md`、`ledger.csv`、`2025/`、`tools/`。
- 仅抽样检查当月数据文件：如 `2025/10.csv` 及 `2025/10/` 下的汇总文件。
- 忽略耗时/无关目录：`.git/`、`.archive/`。
- 若用户未指定月份，默认围绕“当前/最近”月份协作，并在写入前与用户确认目标日期。

## 交互与输出
- 保持简洁直接：先给出要执行的动作预告，再分组展示结果。
- 涉及写入时，必须先给出“解析预览（候选记录）”，征得用户确认后再落盘。
- 多步骤任务使用内置计划工具（update_plan）标记进度；单一步骤任务直接执行即可。

## 数据与编码约定
- CSV 列顺序固定：`日期, 类型, 分类, 金额, 币种, 账户, 商户, 备注`。
- CSV 编码：UTF-8 with BOM（`utf-8-sig`）；Markdown/代码：UTF-8（无 BOM）。
- 汇总口径：`类型=转账` 与/或 `分类=转账` 的行不计入收支汇总。

## 自然语句记账（首选工作流）
目标：用户以自然语句描述今日记账，助手解析→确认→写入对应 `YYYY/MM.csv`。

1) 解析规则（宽松）：
   - 日期：支持“今天/昨天/前天/2025-10-19/10-19/10.19”等，规范化为 `YYYY-MM-DD`。
   - 类型：含“消费/花/买/支出”→`支出`；“收/工资/退款/收入”→`收入`；“转账/转入/转出”→`转账`。
   - 金额：提取整数/小数；
   - 币种：命中“日元/JPY/円”→`JPY`；命中“人民币/元/RMB”→`RMB`；未提及时不猜测币种，需向用户确认（常见默认为 JPY）。
   - 账户：识别常见账户（现金、Suica、Paseli、Amex Gold、ANA Pay、JAL Pay、WAON、乐天Pay、三井NL/Olive/master、PayPay、View Card 等）。未给出则向用户确认；RMB 报销的默认账户为“支付宝”（除非用户另行说明）。
   - 商户：从“在/于/@/＠ …”或紧随品类名后的词抽取（示例：烤肉、KTV、711 等）。
   - 备注：括号内或尾部说明归入备注。

2) AA/报销口径（用户偏好）：
   - 不将 RMB 换算为 JPY；RMB 报销以 `收入(RMB)` 记账，账户默认“支付宝”。
   - 对“多人分摊”的 JPY 支出：如用户说明“1/4”等比例，则直接按个人份额入账（仅记自己的份额）。
   - 如用户仅给出“每人给我 X RMB”，则记录一条 `收入, AA报销, X×N, RMB, 支付宝`；若需要同时入账 JPY 支出，仅按用户个人份额写入。
   - 份额/人数不明确时，先询问确认后再写入。

3) 写入方式：
   - 一律调用脚本：`py -3 tools/add_record.py --date <YYYY-MM-DD> --type <支出|收入|转账> --category <分类> --amount <金额> --currency <JPY|RMB> --account <账户> [--merchant <商户>] [--note <备注>]`。
   - 写入前先展示“候选记录列表”供用户确认。

## 常用任务与命令
- 追加记录：参见上文写入方式。
- 生成月度汇总（按需执行）：`py -3 tools/summarize_month.py 2025/10.csv`。
- 合并总账（按需执行）：`py -3 tools/merge_ledger.py`（将 `2025/*.csv` 合并到 `ledger.csv`）。
- 统一 BOM（按需执行）：`py -3 tools/ensure_bom.py`。

## 注意事项
- 不靠猜测做隐式默认：日期/币种/账户不明确时先问；RMB 报销账户如未指定，默认“支付宝”。
- `.archive/` 为外部助手会话归档，除非用户指示，不参与任何计算或汇总。
- 不在未获指示时自动运行合并/汇总脚本，避免误改数据。

